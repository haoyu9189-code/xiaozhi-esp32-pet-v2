# å¹´ç³•å® ç‰©ç³»ç»Ÿå®Œæ•´äº¤äº’æµç¨‹

## 1ï¸âƒ£ è¯­éŸ³äº¤äº’æµç¨‹

### å”¤é†’ä¸å¯¹è¯
```
ç”¨æˆ·æŒ‰é”®/å”¤é†’è¯
  â†“
Application: StartListening()
  â†“
DeviceState: kIdle â†’ kListening
  â†“
PetStateMachine: OnDeviceStateChanged() â†’ kListeningåŠ¨ä½œ
  â†“ (æ˜¾ç¤ºlistenåŠ¨ç”»)
ç”¨æˆ·è¯´è¯ (VADæ£€æµ‹è¯­éŸ³)
  â†“
DeviceState: kListening â†’ kThinking
  â†“
PetStateMachine: OnDeviceStateChanged() â†’ kThinkingåŠ¨ä½œ
  â†“ (æ˜¾ç¤ºwalkåŠ¨ç”»)
AIå¤„ç† + MCPå·¥å…·è°ƒç”¨
  â†“
DeviceState: kThinking â†’ kSpeaking
  â†“
PetStateMachine: OnDeviceStateChanged() â†’ kSpeakingåŠ¨ä½œ
  â†“ (æ˜¾ç¤ºtalkåŠ¨ç”»)
æ’­æ”¾è¯­éŸ³å›å¤
  â†“
DeviceState: kSpeaking â†’ kIdle
  â†“
PetStateMachine: OnConversationEnd()
  - è§¦å‘OnChatMessage() â†’ é‡‘å¸å¥–åŠ±æ£€æŸ¥
  - éšæœºè§¦å‘playåŠ¨ä½œæå‡happinessï¼ˆ50%æ¦‚ç‡ï¼‰
  - æ‰§è¡Œpending_actionï¼ˆå¯¹è¯ä¸­è§¦å‘çš„åƒé¥­/æ´—æ¾¡ï¼‰
  â†“
æ¢å¤åˆ°ä¹‹å‰çš„å® ç‰©åŠ¨ä½œï¼ˆkIdle/kEating/kBathingç­‰ï¼‰
```

### è¯­éŸ³äº¤äº’æœŸé—´çš„é™åˆ¶
- **å¯ä»¥æ‰§è¡Œ**ï¼špet_moveç§»åŠ¨ã€pet.statusæŸ¥è¯¢ã€memoryè®°å¿†æ“ä½œ
- **å»¶è¿Ÿæ‰§è¡Œ**ï¼špet.interactå–‚é£Ÿ/æ´—æ¾¡ï¼ˆè®¾ä¸ºpending_actionï¼Œç­‰å¯¹è¯ç»“æŸåæ‰§è¡Œï¼‰
- **æ— æ³•æ‰§è¡Œ**ï¼šéœ€è¦ç‹¬å çŠ¶æ€çš„æ“ä½œï¼ˆsleepç­‰ï¼‰

---

## 2ï¸âƒ£ MCPå·¥å…·è°ƒç”¨æµç¨‹

### petå·¥å…· - çŠ¶æ€æŸ¥è¯¢
```
AIè°ƒç”¨: pet(action='status')
  â†“
BuildPetStatusResponse() æ„å»ºJSON
  â†“
è¿”å›æ•°æ®åŒ…å«:
  - ä¸‰é¡¹å±æ€§å€¼ (hunger/cleanliness/happiness: 0-100)
  - é‡‘å¸æ•°æ® (coins, daily_chat_count, total_coins_spent)
  - å¿ƒæƒ…æè¿° (mood)
  - å½“å‰åŠ¨ä½œ (current_action)
  - å¹´é¾„å¤©æ•° (age_days)
  - æ´»åŠ¨ç»Ÿè®¡ (bathe/feed/play/conversationæ¬¡æ•°, days_alive)
  - èƒŒæ™¯è§£é”çŠ¶æ€ (style_backgrounds, unlocked_background_indices)
  - æé†’åˆ—è¡¨ (reminders: æ˜¯å¦éœ€è¦æ´—æ¾¡)
  - èƒŒæ™¯å¥–åŠ±çŠ¶æ€ (reward_playing)
```

### petå·¥å…· - å–‚é£Ÿ
```
AIè°ƒç”¨: pet(action='interact', type='feed')
  â†“
æ£€æŸ¥é‡‘å¸: coins >= 1?
  â”œâ”€ å¦ â†’ è¿”å›"é‡‘å¸ä¸è¶³ï¼éœ€è¦å…ˆæ¡é‡‘å¸æ‰èƒ½å–‚é£Ÿ~"
  â””â”€ æ˜¯ â†“
SpendCoins(1)
  - coins -= 1
  - total_coins_spent += 1
  - ä¿å­˜åˆ°NVS
  â†“
PetStateMachine.Feed()
  â”œâ”€ å¦‚æœåœ¨è¯­éŸ³äº¤äº’ä¸­ â†’ pending_action = kEating (ç­‰å¯¹è¯ç»“æŸæ‰§è¡Œ)
  â””â”€ å¦åˆ™ â†’ ç«‹å³æ‰§è¡Œ â†“
SetAction(kEating, 5åˆ†é’Ÿ)
  - continuous_recovery_action = kEating
  - continuous_recovery_start = å½“å‰æ—¶é—´
  - continuous_recovery_duration = 300000ms (5åˆ†é’Ÿ)
  â†“
æ¯åˆ†é’ŸTick()æ£€æŸ¥:
  - hunger += 20 (æ¯åˆ†é’Ÿæ¢å¤)
  - å¦‚æœhunger >= 100 â†’ æå‰ç»“æŸï¼Œå›åˆ°kIdle
  - 5åˆ†é’Ÿåè‡ªåŠ¨ç»“æŸ
  â†“
ActivityCounters.feed_count++
  â†“
è¿”å›: "å–‚é£ŸæˆåŠŸï¼æ¶ˆè€—1é‡‘å¸ï¼Œå¼€å§‹åƒé¥­ï¼ˆæŒç»­5åˆ†é’Ÿï¼Œæ¯åˆ†é’Ÿ+20é¥±é£Ÿåº¦ï¼‰"
  + å¦‚æœhunger>=100 && cleanliness>=100: "é¥¥é¥¿å’Œæ¸…æ´éƒ½æ»¡äº†ï¼Œå¿ƒæƒ…å˜å¾—è¶…å¥½ï¼"
```

### petå·¥å…· - æ´—æ¾¡
```
AIè°ƒç”¨: pet(action='interact', type='bathe')
  â†“
æ£€æŸ¥é‡‘å¸: coins >= 1?
  â”œâ”€ å¦ â†’ è¿”å›"é‡‘å¸ä¸è¶³ï¼éœ€è¦å…ˆæ¡é‡‘å¸æ‰èƒ½æ´—æ¾¡~"
  â””â”€ æ˜¯ â†“
SpendCoins(1)
  - coins -= 1
  - total_coins_spent += 1
  - ä¿å­˜åˆ°NVS
  â†“
PetStateMachine.Bathe()
  â”œâ”€ å¦‚æœåœ¨è¯­éŸ³äº¤äº’ä¸­ â†’ pending_action = kBathing (ç­‰å¯¹è¯ç»“æŸæ‰§è¡Œ)
  â””â”€ å¦åˆ™ â†’ ç«‹å³æ‰§è¡Œ â†“
SetAction(kBathing, 5åˆ†é’Ÿ)
  - continuous_recovery_action = kBathing
  - continuous_recovery_start = å½“å‰æ—¶é—´
  - continuous_recovery_duration = 300000ms (5åˆ†é’Ÿ)
  â†“
SceneItemManager.ClearAllPoops()
  - éå†æ‰€æœ‰ä¾¿ä¾¿
  - æ¯ä¸ªä¾¿ä¾¿50%æ¦‚ç‡ç”Ÿæˆé‡‘å¸
  - è¿”å›æ¸…ç†çš„ä¾¿ä¾¿æ•°é‡poop_count
  â†“
æ¯åˆ†é’ŸTick()æ£€æŸ¥:
  - cleanliness += 20 (æ¯åˆ†é’Ÿæ¢å¤)
  - å¦‚æœcleanliness >= 100 â†’ æå‰ç»“æŸï¼Œå›åˆ°kIdle
  - 5åˆ†é’Ÿåè‡ªåŠ¨ç»“æŸ
  â†“
ActivityCounters.bathe_count++
  â†“
CheckAchievements()
  - bathe_count == 5 â†’ è§£é”èµ›åšæœ‹å…‹èƒŒæ™¯
  - bathe_count == 20 â†’ è§£é”å¥‡å¹»æ£®æ—èƒŒæ™¯
  â†“
è¿”å›: "æ´—æ¾¡æˆåŠŸï¼æ¶ˆè€—1é‡‘å¸ï¼Œå¼€å§‹æ´—æ¾¡ï¼ˆæŒç»­5åˆ†é’Ÿï¼Œæ¯åˆ†é’Ÿ+20æ¸…æ´åº¦ï¼‰"
  + "æ¸…ç†äº†Xä¸ªä¾¿ä¾¿ï¼ˆä¾¿ä¾¿å¤„æœ‰50%æ¦‚ç‡åˆ·å‡ºé‡‘å¸ï¼‰"
  + å¦‚æœhunger>=100 && cleanliness>=100: "é¥¥é¥¿å’Œæ¸…æ´éƒ½æ»¡äº†ï¼Œå¿ƒæƒ…å˜å¾—è¶…å¥½ï¼"
```

### pet_moveå·¥å…· - ç§»åŠ¨
```
AIè°ƒç”¨: pet_move(direction='left', distance=30)
  â†“
æ£€æŸ¥ç§»åŠ¨æ¡ä»¶ (mcp_move_can_start):
  - ä¸èƒ½åœ¨walking_off/walking_backåŠ¨ç”»ä¸­
  - ä¸èƒ½åœ¨touch/swipeäº¤äº’ä¸­
  - ä¸èƒ½åœ¨sleepingçŠ¶æ€
  - ä¸èƒ½åœ¨power walkå†·å´æœŸé—´
  - ä¸èƒ½åœ¨eating/bathing/sleepingåŠ¨ä½œä¸­
  - âœ… å¯ä»¥åœ¨listening/speaking/thinkingçŠ¶æ€ä¸­ç§»åŠ¨
  â†“
è°ƒç”¨move_callback(direction, distance)
  â†“
æ¿çº§ä»£ç  (esp32-c6-lcd-1.69.cc):
  - è®¡ç®—æ–°ä½ç½®å¹¶é™åˆ¶è¾¹ç•Œ
  - å¯åŠ¨ç¼“åŠ¨åŠ¨ç”» (ease-in-out, 1ç§’)
  - æ’­æ”¾walkåŠ¨ç”»
  â†“
åŠ¨ç”»ç»“æŸå:
  - SceneItemManager.CheckCollision(pet_x, pet_y)
    â”œâ”€ æ£€æŸ¥é‡‘å¸ç¢°æ’ (è·ç¦»<30px)
    â”‚   â””â”€ OnCoinPickup():
    â”‚       - å¥–åŠ±1-3é‡‘å¸
    â”‚       - 1%æ¦‚ç‡è§£é”éšæœºèƒŒæ™¯
    â”‚       - ç§»é™¤é‡‘å¸
    â”œâ”€ æ£€æŸ¥ä¾¿ä¾¿ç¢°æ’ (è·ç¦»<30px)
    â”‚   â””â”€ OnPoopStep():
    â”‚       - cleanliness -= 10
    â”‚       - happiness -= 5
    â”‚       - step_count++
    â”‚       - å¦‚æœstep_count>=3: ç§»é™¤ä¾¿ä¾¿ï¼Œ50%æ¦‚ç‡ç”Ÿæˆé‡‘å¸
    â””â”€ æ›´æ–°ä½ç½®
  â†“
è¿”å›: "å® ç‰©å¼€å§‹å‘Xç§»åŠ¨Yåƒç´ "
æˆ– "ç§»åŠ¨å¤±è´¥ï¼šå® ç‰©æ­£å¿™æˆ–å·²åˆ°è¾¾è¾¹ç•Œ"
```

### memoryå·¥å…·
```
AIè°ƒç”¨: memory.create / memory.search / memory.update / memory.delete
  â†“
ä¸MCPæœåŠ¡å™¨memoryå·¥å…·äº¤äº’
  â†“
å­˜å‚¨/æ£€ç´¢å¯¹è¯è®°å¿†å’Œé‡è¦äº‹ä»¶
```

### end_conversationå·¥å…·
```
AIè°ƒç”¨: end_conversation()
  â†“
Application.StopListening()
  â†“
DeviceState: â†’ kIdle
  â†“
ç»“æŸå¯¹è¯ï¼Œè¿”å›å¾…æœºçŠ¶æ€
```

---

## 3ï¸âƒ£ å±æ€§è‡ªç„¶è¡°å‡æµç¨‹

### æ¯åˆ†é’ŸTick()è°ƒç”¨
```
PetStateMachine.Tick() (æ¯60ç§’)
  â†“
1. å¹´é¾„å¢é•¿: age_minutes++
  â†“
2. æ£€æŸ¥æŒç»­æ¢å¤åŠ¨ä½œ (continuous_recovery_action)
   â”œâ”€ kEating â†’ hunger += 20, æ»¡äº†æˆ–è¶…æ—¶ç»“æŸ
   â””â”€ kBathing â†’ cleanliness += 20, æ»¡äº†æˆ–è¶…æ—¶ç»“æŸ
  â†“
3. å±æ€§è¡°å‡ (decay_tick_counterå¾ªç¯0,1,2)
   - é¥¥é¥¿åº¦: æ¯3åˆ†é’Ÿ -1
   - å¿ƒæƒ…å€¼: æ¯1åˆ†é’Ÿ -1
   - æ¸…æ´åº¦: æ¯10åˆ†é’Ÿ -1
  â†“
4. é‡‘å¸ç”Ÿæˆæ£€æŸ¥ (happy_coin_timer++)
   æ¡ä»¶: hunger>50 && cleanliness>50 && happiness>50
   é¢‘ç‡è®¡ç®—:
   - å¹³å‡å±æ€§ avg = (H+C+HP)/3
   - avg >= 90: æ¯5åˆ†é’Ÿç”Ÿæˆ
   - avg >= 80: æ¯10åˆ†é’Ÿç”Ÿæˆ
   - avg >= 70: æ¯20åˆ†é’Ÿç”Ÿæˆ
   - å…¶ä»–: æ¯30åˆ†é’Ÿç”Ÿæˆ
   - æœ‰ä¾¿ä¾¿æ—¶å»¶è¿Ÿ: interval *= (10 + poop_count*5) / 10
   åˆ°æ—¶é—´ â†’ SceneItemManager.SpawnCoin()
  â†“
5. ä¾¿ä¾¿ç”Ÿæˆæ£€æŸ¥
   æ¡ä»¶: hunger > 0 (åªè¦ä¸æ˜¯å®Œå…¨ç©ºè…¹)
   é¢‘ç‡: éšæœº30åˆ†é’Ÿ-4å°æ—¶
   é™åˆ¶: æ¯å¤©æœ€å¤š12æ¬¡
   åˆ°æ—¶é—´ â†’ SceneItemManager.SpawnPoop()
  â†“
6. åŒæ»¡å¥–åŠ±æ£€æŸ¥
   å¦‚æœ hunger>=100 && cleanliness>=100:
     happiness = 100
  â†“
7. è‡ªåŠ¨æ¶ˆè´¹æ£€æŸ¥ (CoinSystem.CheckAutoConsumption, æ¯åˆ†é’Ÿ)
   - hunger < 5 && coins >= 1 â†’ è‡ªåŠ¨Feed()
   - cleanliness < 5 && coins >= 1 â†’ è‡ªåŠ¨Bathe()
  â†“
8. èƒŒæ™¯å¥–åŠ±è®¡æ—¶å™¨ (CoinSystem.CheckRewardTimer)
   å¦‚æœreward_playing && è¶…è¿‡10åˆ†é’Ÿ:
     â†’ BackgroundManager.ClearForce()
     â†’ reward_playing = false
  â†“
9. ä¿å­˜åˆ°NVS (çŠ¶æ€å˜åŒ–æ—¶)
```

---

## 4ï¸âƒ£ é‡‘å¸ç³»ç»Ÿå®Œæ•´æµç¨‹

### é‡‘å¸è·å–é€”å¾„

#### èŠå¤©å¥–åŠ±
```
æ¯æ¬¡å¯¹è¯ç»“æŸ â†’ CoinSystem.OnChatMessage()
  â†“
CheckDailyReset() (æ£€æŸ¥æ—¥æœŸæ˜¯å¦å˜åŒ–ï¼Œé‡ç½®daily_chat_count)
  â†“
daily_chat_count++
  â†“
æ£€æŸ¥é‡Œç¨‹ç¢‘:
  - ç¬¬1å¥: +2é‡‘å¸
  - ç¬¬5å¥: +2é‡‘å¸
  - ç¬¬6å¥: +2é‡‘å¸
  - ç¬¬6å¥åæ¯10å¥: +1é‡‘å¸ (16,26,36...)
  â†“
AddCoins(reward)
  â†“
ä¿å­˜åˆ°NVS
```

#### è‡ªåŠ¨ç”Ÿæˆé‡‘å¸
```
æ¯åˆ†é’ŸTick() â†’ æ£€æŸ¥ç”Ÿæˆæ¡ä»¶
  â†“
æ¡ä»¶: hunger>50 && cleanliness>50 && happiness>50
  â†“
è®¡ç®—ç”Ÿæˆé—´éš”:
  avg = (hunger + cleanliness + happiness) / 3
  - avg >= 90: 5åˆ†é’Ÿ
  - avg >= 80: 10åˆ†é’Ÿ
  - avg >= 70: 20åˆ†é’Ÿ
  - å…¶ä»–: 30åˆ†é’Ÿ
  â†“
ä¾¿ä¾¿å»¶è¿Ÿæƒ©ç½š:
  interval *= (10 + poop_count*5) / 10
  ä¾‹: 1ä¸ªä¾¿ä¾¿ â†’ 1.5å€, 2ä¸ªä¾¿ä¾¿ â†’ 2å€
  â†“
happy_coin_timer >= interval ?
  â†“
SceneItemManager.SpawnCoin()
  - éšæœºä½ç½® (Â±60px X, Â±15px Y)
  - æ£€æŸ¥æ˜¯å¦è¶…è¿‡MAX_SCENE_COINS(5)
  - ç”Ÿæˆé‡‘å¸ï¼Œé‡ç½®è®¡æ—¶å™¨
```

#### æ¡é‡‘å¸
```
ç§»åŠ¨ç»“æŸ â†’ CheckCollision()
  â†“
è·ç¦»é‡‘å¸ < 30px ?
  â†“
OnCoinPickup(index)
  â†“
éšæœºå¥–åŠ±1-3é‡‘å¸
  â†“
1%æ¦‚ç‡è§£é”éšæœºèƒŒæ™¯ (TryUnlockRandomBackground)
  â†“
ç§»é™¤é‡‘å¸: coins[index].active = false
  â†“
CoinSystem.AddCoins(amount)
```

#### è¸©ä¾¿ä¾¿åç”Ÿæˆ
```
è¸©ä¾¿ä¾¿ â†’ step_count++
  â†“
step_count >= 3 (è¸©3æ¬¡å)
  â†“
50%æ¦‚ç‡: SpawnCoinAt(ä¾¿ä¾¿ä½ç½®)
  â†“
ç§»é™¤ä¾¿ä¾¿: poops[index].active = false
```

#### æ´—æ¾¡æ¸…ç†ä¾¿ä¾¿
```
Bathe() â†’ ClearAllPoops()
  â†“
éå†æ‰€æœ‰activeä¾¿ä¾¿
  â†“
æ¯ä¸ªä¾¿ä¾¿50%æ¦‚ç‡: SpawnCoinAt(ä¾¿ä¾¿ä½ç½®)
  â†“
æ¸…ç©ºæ‰€æœ‰ä¾¿ä¾¿
```

### é‡‘å¸æ¶ˆè´¹é€”å¾„

#### å–‚é£Ÿæ¶ˆè´¹
```
pet(action='interact', type='feed')
  â†“
SpendCoins(1)
  - coins -= 1
  - total_coins_spent += 1
  - Save()
```

#### æ´—æ¾¡æ¶ˆè´¹
```
pet(action='interact', type='bathe')
  â†“
SpendCoins(1)
  - coins -= 1
  - total_coins_spent += 1
  - Save()
```

#### èƒŒæ™¯å¥–åŠ±è§¦å‘
```
AddCoins() â†’ æ£€æŸ¥è§¦å‘æ¡ä»¶
  â†“
coins >= 10 && !reward_playing?
  â†“
æ£€æŸ¥å® ç‰©çŠ¶æ€: hunger>5 && happiness>5 && cleanliness>5?
  â†“
TriggerRewardBackground()
  - SpendCoins(10)
  - total_coins_spent += 10
  - éšæœºé€‰æ‹©å·²è§£é”çš„ç‰¹æ®ŠèƒŒæ™¯
  - BackgroundManager.ForceBackground(bg_index)
  - reward_playing = true
  - reward_start_time = å½“å‰æ—¶é—´
  â†“
æŒç»­10åˆ†é’Ÿåè‡ªåŠ¨ç»“æŸ
```

#### è‡ªåŠ¨æ¶ˆè´¹ï¼ˆç”Ÿå­˜æœºåˆ¶ï¼‰
```
æ¯åˆ†é’ŸCheckAutoConsumption()
  â†“
hunger < 5 && coins >= 1?
  â†“
SpendCoins(1) â†’ Feed()
  â†“
cleanliness < 5 && coins >= 1?
  â†“
SpendCoins(1) â†’ Bathe()
```

---

## 5ï¸âƒ£ åœºæ™¯ç‰©å“äº¤äº’æµç¨‹

### é‡‘å¸ç”Ÿæˆ
```
SceneItemManager.SpawnCoin()
  â†“
æ£€æŸ¥: coin_count < MAX_SCENE_COINS(5)?
  â†“
GetRandomPosition(&x, &y)
  - x: Â±60px
  - y: Â±15px
  â†“
SpawnCoinInternal(x, y)
  - coins[slot] = {x, y, SCENE_ITEM_COIN, 0, true}
  - coin_count++
  - Save()
```

### ä¾¿ä¾¿ç”Ÿæˆ
```
æ¯åˆ†é’ŸTick() â†’ CheckPoopSpawn(hunger)
  â†“
æ¡ä»¶æ£€æŸ¥:
  - hunger > 0 (ä¸æ˜¯å®Œå…¨ç©ºè…¹)
  - poop_count < MAX_SCENE_POOPS(3)
  - daily_poop_spawns < POOP_MAX_DAILY_SPAWNS(12)
  - åˆ°è¾¾next_poop_spawn_time
  â†“
SpawnPoop()
  - GetRandomPosition(&x, &y)
  - poops[slot] = {x, y, SCENE_ITEM_POOP, 0, true}
  - poop_count++
  - daily_poop_spawns++
  - ScheduleNextPoopSpawn() (30åˆ†é’Ÿ-4å°æ—¶)
  - Save()
```

### ç¢°æ’æ£€æµ‹
```
ç§»åŠ¨ç»“æŸ â†’ CheckCollision(pet_x, pet_y)
  â†“
éå†æ‰€æœ‰activeé‡‘å¸:
  distance = âˆš((pet_x-coin.x)Â² + (pet_y-coin.y)Â²)
  â†“
distance < COIN_PICKUP_DISTANCE(30)?
  â†“
OnCoinPickup(i)
  - å¥–åŠ±1-3é‡‘å¸
  - 1%æ¦‚ç‡è§£é”èƒŒæ™¯
  - ç§»é™¤é‡‘å¸
  â†“
éå†æ‰€æœ‰activeä¾¿ä¾¿:
  distance = âˆš((pet_x-poop.x)Â² + (pet_y-poop.y)Â²)
  â†“
distance < POOP_STEP_DISTANCE(30)?
  â†“
OnPoopStep(i)
  - cleanliness -= 10
  - happiness -= 5
  - step_count++
  - å¦‚æœstep_count>=3: ç§»é™¤ä¾¿ä¾¿ï¼Œ50%æ¦‚ç‡ç”Ÿæˆé‡‘å¸
```

---

## 6ï¸âƒ£ æˆå°±ä¸èƒŒæ™¯è§£é”æµç¨‹

### é£æ ¼èƒŒæ™¯è§£é”ï¼ˆæ´»åŠ¨è§¦å‘ï¼‰
```
æ´»åŠ¨è®¡æ•°å™¨æ›´æ–°:
  - OnBathe() â†’ bathe_count++
  - OnFeed() â†’ feed_count++
  - OnConversation() â†’ conversation_count++
  - OnDayPassed() â†’ days_alive++
  â†“
CheckAchievements()
  â†“
æ£€æŸ¥é‡Œç¨‹ç¢‘:
  - bathe_count == 5 â†’ è§£é”èµ›åšæœ‹å…‹ (BG_STYLE_CYBERPUNK)
  - bathe_count == 20 â†’ è§£é”å¥‡å¹»æ£®æ— (BG_STYLE_FANTASY)
  - conversation_count == 10 â†’ è§£é”æ˜Ÿç©º (BG_STYLE_SPACE)
  - days_alive == 7 â†’ è§£é”è’¸æ±½æœ‹å…‹ (BG_STYLE_STEAMPUNK)
  â†“
UnlockBackground(bit, type, bg_name)
  - unlocked.flags |= bit
  - è§¦å‘achievement_callback
  - Save()
```

### èŠ‚æ—¥èƒŒæ™¯è§£é”ï¼ˆMCPè°ƒç”¨ï¼‰
```
AIè°ƒç”¨èƒŒæ™¯è´­ä¹°æˆ–èŠ‚æ—¥è§£é”
  â†“
PetAchievements.UnlockChristmas() ç­‰
  â†“
UnlockFestival(bit, name)
  - unlocked.flags |= bit
  - Save()
```

### å¹¸è¿è§£é”ï¼ˆ1%æ¦‚ç‡ï¼‰
```
OnCoinPickup() â†’ 1%æ¦‚ç‡
  â†“
TryUnlockRandomBackground()
  â†“
æ”¶é›†æ‰€æœ‰æœªè§£é”çš„èƒŒæ™¯
  â†“
éšæœºé€‰æ‹©ä¸€ä¸ªè§£é”
  - styleèƒŒæ™¯: UnlockCyberpunk/Fantasy/Space/Steampunk
  - festivalèƒŒæ™¯: UnlockChristmas/Birthdayç­‰
  â†“
æ˜¾ç¤ºæç¤º: "å¹¸è¿è§£é”èƒŒæ™¯: XXX"
```

---

## 7ï¸âƒ£ äº²å¯†åº¦ç³»ç»Ÿæµç¨‹

### ç´¯è®¡æ¶ˆè´¹è¿½è¸ª
```
ä»»ä½•é‡‘å¸æ¶ˆè´¹ â†’ SpendCoins(amount)
  â†“
total_coins_spent += amount
  â†“
Save()
```

### æ¶ˆè´¹æ¥æº
- å–‚é£Ÿ: +1
- æ´—æ¾¡: +1
- èƒŒæ™¯å¥–åŠ±: +10
- è‡ªåŠ¨æ¶ˆè´¹: +1/æ¬¡

### äº²å¯†åº¦é˜¶æ®µï¼ˆæ ¹æ®total_coins_spentï¼‰
```
0-20: é™Œç”ŸæœŸ - è°¨æ…ä¿æŒè·ç¦»
21-50: ç†Ÿæ‚‰æœŸ - å¶å°”æ’’å¨‡
51-100: äº²å¯†æœŸ - è‡ªç„¶éšæ„
101-200: æ·±åšæœŸ - ä¿¡ä»»ä¾èµ–
201+: çµé­‚ä¼´ä¾£ - å®Œå…¨é»˜å¥‘
```

### AIè·å–äº²å¯†åº¦æ•°æ®
```
æ¯è½®å¯¹è¯å¼€å§‹ â†’ pet(action='status')
  â†“
è¿”å›JSONåŒ…å«: total_coins_spent
  â†“
AIæ ¹æ®æ•°å€¼è°ƒæ•´å¯¹è¯é£æ ¼å’Œäº²å¯†åº¦
```

---

## 8ï¸âƒ£ æ¯æ—¥é‡ç½®æµç¨‹

### é‡‘å¸ç³»ç»Ÿæ—¥é‡ç½®
```
æ¯æ¬¡OnChatMessage() â†’ CheckDailyReset()
  â†“
è·å–å½“å‰æ—¥æœŸ: current_year, current_day
  â†“
ä¸last_reset_year, last_reset_dayæ¯”è¾ƒ
  â†“
æ—¥æœŸå˜åŒ–?
  â†“
é‡ç½®: daily_chat_count = 0
  â†“
æ›´æ–°: last_reset_year, last_reset_day
  â†“
Save()
```

### åœºæ™¯ç‰©å“æ—¥é‡ç½®
```
æ¯ç§’Tick() â†’ CheckDailyReset()
  â†“
æ—¥æœŸå˜åŒ–?
  â†“
é‡ç½®:
  - daily_poop_spawns = 0
  - last_poop_spawn_day = current_day
  - last_coin_spawn_day = current_day
  â†“
Save()
```

---

## ğŸ¯ å®Œæ•´äº¤äº’å¾ªç¯ç¤ºä¾‹

### å…¸å‹å¯¹è¯æµç¨‹
```
1. ç”¨æˆ·æŒ‰é”®å”¤é†’
   â†“
2. DeviceState: kIdle â†’ kListening
   PetAction: kIdle â†’ kListening
   åŠ¨ç”»: listen
   â†“
3. ç”¨æˆ·: "å¹´ç³•ä½ å¥½å‘€"
   â†“
4. DeviceState: kListening â†’ kThinking
   PetAction: kListening â†’ kThinking
   åŠ¨ç”»: walk
   AIè°ƒç”¨: pet(action='status')
   è·å–: hunger=60, cleanliness=70, happiness=80, coins=5, total_coins_spent=25 (ç†Ÿæ‚‰æœŸ)
   â†“
5. AIç”Ÿæˆå›å¤: "ä¸»äººå¥½å‘€~ ä»Šå¤©å¿ƒæƒ…ä¸é”™å‘¢ï¼" (æ ¹æ®happiness=80,ç†Ÿæ‚‰æœŸé£æ ¼)
   â†“
6. DeviceState: kThinking â†’ kSpeaking
   PetAction: kThinking â†’ kSpeaking
   åŠ¨ç”»: talk
   æ’­æ”¾è¯­éŸ³
   â†“
7. DeviceState: kSpeaking â†’ kIdle
   PetAction: kSpeaking â†’ kIdle
   OnConversationEnd():
     - daily_chat_count++
     - æ£€æŸ¥èŠå¤©å¥–åŠ±ï¼ˆå¦‚æœæ˜¯ç¬¬1/5/6å¥æˆ–æ¯10å¥ï¼‰
     - 50%æ¦‚ç‡è§¦å‘playåŠ¨ä½œ â†’ happiness+10
   åŠ¨ç”»: idle
   â†“
8. åå°Tick()ç»§ç»­è¿è¡Œ:
   - å±æ€§è¡°å‡
   - é‡‘å¸ç”Ÿæˆå€’è®¡æ—¶
   - ä¾¿ä¾¿ç”Ÿæˆå€’è®¡æ—¶
   - æŒç»­æ¢å¤æ£€æŸ¥
```

---

## ğŸ“Š æ•°æ®æŒä¹…åŒ–ï¼ˆNVSï¼‰

æ‰€æœ‰ä»¥ä¸‹æ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°NVSï¼š

### PetStateMachine
- stats_ (hunger, cleanliness, happiness, age_minutes)
- continuous_recovery_action, continuous_recovery_start, continuous_recovery_duration

### CoinSystem
- coins
- daily_chat_count
- last_reset_day, last_reset_year
- total_coins_spent

### SceneItemManager
- coins[5], poops[3]
- coin_count, poop_count
- last_coin_spawn_hour, last_coin_spawn_day
- last_poop_spawn_day, daily_poop_spawns
- next_poop_spawn_time

### PetAchievements
- counters (bathe/feed/play/conversation_count, days_alive)
- unlocked (flagsä½æ©ç )

---

## ğŸ”§ è°ƒè¯•å·¥å…·

### debug_spawn_items
```
MCPè°ƒç”¨: debug_spawn_items(type='coin/poop/both')
  â†“
å¼ºåˆ¶ç”Ÿæˆæµ‹è¯•ç‰©å“ç”¨äºéªŒè¯æ˜¾ç¤º
```
