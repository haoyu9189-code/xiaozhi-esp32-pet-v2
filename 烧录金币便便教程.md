# 金币和便便不显示问题修复教程

## 问题诊断

如果您看不到屏幕上的金币💰和便便💩，原因是物品资源数据未烧录到设备。

## 快速修复步骤

### 方法一：使用一键烧录脚本（推荐）

```cmd
:: 替换 COM10 为你的实际端口号（如 COM3, COM4 等）
flash_assets.bat COM10
```

这个脚本会自动：
1. 检测 `gifs/frames.bin` (动画)
2. 检测 `gifs/backgrounds.bin` (背景)
3. 检测 `gifs/items/frames.bin` (金币/便便)
4. 合并所有文件并烧录到 0x800000

### 方法二：手动烧录（如果脚本失败）

**步骤1: 在CMD中合并资源文件**
```cmd
:: 注意：必须在CMD中运行，不能在PowerShell中
cd D:\xiaozhi\xiaozhi-esp32-main
copy /b gifs\frames.bin + gifs\backgrounds.bin + gifs\items\frames.bin gifs\assets.bin
```

**步骤2: 烧录到设备**
```cmd
:: 替换 COM10 为你的实际端口号
python -m esptool --chip esp32c6 --port COM10 --baud 921600 write_flash 0x800000 gifs\assets.bin
```

**步骤3: 重启设备**
```cmd
:: 按设备上的复位按钮，或运行
python -m esptool --chip esp32c6 --port COM10 reset
```

## 验证是否成功

烧录完成后，查看设备日志，应该看到：

```
I (xxx) waveshare_lcd_1_69: ItemLoader initialized: 40x40, 2 items
I (xxx) waveshare_lcd_1_69: SceneItemManager initialized
```

如果看到以下警告，说明物品数据未正确烧录：
```
W (xxx) waveshare_lcd_1_69: ItemLoader init failed - scene items disabled
```

## 物品出现条件

即使资源烧录成功，金币和便便也不会立即出现，需要满足以下条件：

### 金币生成规则
- **整点刷新**：每小时整点有50%概率在随机位置生成1-3个金币
- **条件**：屏幕上没有便便时才会生成（先清理便便才会刷金币）
- **最多数量**：同时最多5个金币
- **拾取**：宠物行走到金币60像素范围内自动拾取

### 便便生成规则
- **饱食触发**：宠物饱食度 > 90 时（吃饱了才会拉💩）
- **每日限制**：每天最多生成1-3个便便
- **时间间隔**：随机等待30-90分钟后生成下一个
- **最多数量**：同时最多3个便便
- **清理**：宠物走过3次后消失，或洗澡时清除所有便便

## 数据文件结构

`gifs/assets.bin` 文件布局（大小根据实际资源变化）：

| 数据类型 | 偏移地址 | 计算方式 | 说明 |
|---------|---------|---------|------|
| 动画数据 | 0 | 帧数 × 26,368 | 来自 `gifs/frames.bin` |
| 背景数据 | 动画数据末尾 | 背景数 × 67,968 | 来自 `gifs/backgrounds.bin` |
| 物品数据 | 背景数据末尾 | 固定 4,730 | 来自 `gifs/items/frames.bin` |

**查看实际数量**：参考 `gifs/index.json` 中的 `animations` 和 `backgrounds` 数组长度。

## 测试物品系统

烧录成功后，可以通过以下方式测试：

1. **查看宠物状态**：
   - 对小智说："查看我的宠物状态"
   - 会显示当前金币数量和便便数量

2. **手动触发**：
   - **喂食**：消耗1金币，增加饱食度（吃饱后会生成便便）
   - **洗澡**：消耗1金币，增加清洁度（会清除所有便便，便便处50%概率刷出金币）

3. **等待自动刷新**：
   - 等到下一个整点（如14:00），有50%概率生成金币
   - 喂食到饱食度>90后，等待30-90分钟会生成便便

## 故障排除

如果烧录后仍然没有金币/便便：

1. **检查日志是否有 ItemLoader 警告**
2. **确认 gifs/items/frames.bin 文件大小为 4730 字节**
3. **重新运行合并命令**（可能之前合并失败）
4. **检查分区表是否支持 4.5MB assets分区**

## 常见问题

**Q: 烧录成功但还是看不到？**
A: 可能需要等待触发条件。试试：
   - 等待下一个整点看是否刷新金币
   - 喂食到饱食度>90等待便便生成

**Q: PowerShell中运行 copy /b 报错？**
A: 必须使用 CMD，不支持 PowerShell。打开 CMD 窗口运行。

**Q: esptool 报错找不到端口？**
A: 检查设备管理器中的COM端口号，替换命令中的 COM10。

## 需要帮助？

如果以上步骤都无法解决问题，请提供以下信息：
1. 设备启动日志（包含 ItemLoader 相关信息）
2. `flash_assets.bat` 的输出
3. `gifs/assets.bin` 文件大小
