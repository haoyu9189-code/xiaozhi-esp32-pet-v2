# 年糕系统综合优化计划

## 概述

本计划基于对现有系统的全面理解，整合了以下文档的内容：
- [记忆系统架构说明.md](记忆系统架构说明.md) - 9种数据类型，MCP工具接口
- [内存优化计划.md](内存优化计划.md) - 内存冲突优化（3阶段）
- [交互流程说明.md](交互流程说明.md) - 完整交互流程，状态机
- [改动说明.md](改动说明.md) - 动画系统，FS格式
- [内存优化说明.md](内存优化说明.md) - 按需加载，深层记忆存储

## 当前系统状态

### 已完成功能 ✅

#### 记忆系统
- ✅ 9种数据类型（Profile, Preferences, Family, Facts, Traits, Habits, Events, Goals, Moments）
- ✅ NVS存储（48KB，使用约31%）
- ✅ MCP工具接口（read/write/delete/search）
- ✅ 按需加载优化（type过滤，避免超时）
- ✅ PendingMemory确认机制（2次提及阈值）

#### 日程管理
- ✅ Phase 1: 优先级可视化（significance字段，1-5排序）
- ✅ Phase 2: 智能提醒时机（GetUpcomingSchedules，每10分钟检查，提前60分钟提醒）
- ✅ Phase 3: 重复日程支持（REPEAT_DAILY/WEEKLY/MONTHLY，自动生成下一次）

#### 交互系统
- ✅ 状态机（Idle/Listening/Speaking/Wandering）
- ✅ 触摸交互（触发对话+触摸动画）
- ✅ 金币系统（触摸积分，解锁背景）
- ✅ 属性衰减（happiness/hunger/cleanliness）
- ✅ 环境对白（AmbientDialogue，低饥饿度/低清洁度/长时间不交互）

#### 动画系统
- ✅ FS格式（4-bit/8-bit索引色）
- ✅ 动画管理器（AnimationLoader，esp_partition_read）
- ✅ 背景管理器（BackgroundLoader，解锁机制）
- ✅ 状态驱动动画切换（Idle→呼吸，Listening→聆听，Speaking→说话）

### 待实现功能 ⏳

#### 日程管理（高级功能）
- ⏳ Phase 4: 冲突检测（时间重叠检查，建议替代时间）
- ⏳ Phase 5: 上下文相关性（结合pet状态建议任务时间）

#### 深层记忆存储
- ⏳ 阶段1: 基础归档（Asset分区存储历史记忆，JSONL格式）
- ⏳ 阶段2: 回忆检索（从归档中检索历史记忆，MCP action='recall'）

#### 内存冲突优化（from 内存优化计划.md）
- ⏳ 阶段2: 架构优化（Opus解码器预分配，操作调度器）
- ⏳ 阶段3: 系统协调（系统内存监控，降级策略）

---

## 优先级排序

### P0 - 立即实施（本周内）

#### 1. 日程冲突检测（Phase 4）

**价值**：防止日程重叠，提升用户体验

**实现方案**：
```cpp
// 文件：main/memory/memory_storage.h/cc
struct ConflictInfo {
    bool has_conflict;
    Event conflicting_event;
    std::vector<std::string> suggested_times;
};

ConflictInfo CheckScheduleConflict(const char* date, const char* time, int duration_minutes = 60);
```

**集成点**：
- `memory_mcp_tools.cc::HandleWrite()` - schedule添加前检查冲突
- 返回格式：`"conflict: '开会' at 2026-02-05 14:00 conflicts with '团队会议'. Suggested times: 13:00, 16:00"`

**System Prompt**：
```
【日程冲突处理】
- 添加日程时若冲突，年糕自然提醒并建议替代时间
- 自然表达："诶，那个时间你已经有个会议了，要不改到3点？"
- 不要机械读取："检测到冲突，建议时间：15:00, 17:00"
```

**预计工作量**：2-3小时

---

#### 2. 深层记忆归档（阶段1）

**价值**：释放NVS空间，保留历史记忆，为长期使用做准备

**实现方案**：
- 新增文件：`main/memory/memory_archive.h/cc`
- 归档策略：
  - ChatMessage: 超过30条时归档最早的10条
  - Facts: 每日凌晨归档>30天的
  - Moments: 每日凌晨归档>30天的
  - Events: 每周日归档已过的纪念日

**存储格式**：
```
/spiffs/memory/
  ├── chat_archive.jsonl
  ├── facts_archive.jsonl
  ├── moments_archive.jsonl
  └── events_archive.jsonl
```

**集成点**：
- `MemoryStorage::AddFact()` - 检查并触发归档
- `MemoryStorage::AddMoment()` - 检查并触发归档
- `Application::OnClockTimer()` - 每日凌晨检查

**预计工作量**：3-4小时

---

### P1 - 短期实施（2周内）

#### 3. 上下文相关日程建议（Phase 5）

**价值**：智能建议任务时间，结合宠物状态

**实现方案**：
```cpp
// 文件：main/memory/memory_storage.h/cc
struct ScheduleSuggestion {
    std::string reason;
    bool is_good_time;
    int recommended_hour;
};

ScheduleSuggestion GetScheduleSuggestion(const Event& schedule, const PetStats& pet_stats);
```

**建议逻辑**：
- 高优先级任务 + 宠物状态差（happiness/hunger/cleanliness < 30）→ 建议休息后再做
- 低优先级任务 + 宠物状态差 → 建议推迟
- 夜间任务（22:00-06:00）→ 建议改到白天

**System Prompt**：
```
【智能日程建议】
- memory返回的日程若包含 is_good_time=false，说明当前状态不适合
- 自然表达："你现在看起来累了，重要会议建议休息后再开"
- 结合状态：饿了/累了/脏了时，不建议高强度任务
```

**预计工作量**：2-3小时

---

#### 4. 回忆检索功能（阶段2）

**价值**：让年糕能够"回忆"起更早的对话和事件

**实现方案**：
- 扩展 `MemoryArchive` 类，添加检索接口
- MCP 工具扩展：`action='recall'`
- 检索方式：
  - 按时间范围：`memory(action='recall', type='fact', start_date='2025-12-01', end_date='2025-12-31')`
  - 按关键词：`memory(action='recall', type='moment', keyword='生日')`
  - 最早记忆：`memory(action='recall', type='chat', limit=10, order='oldest')`

**性能优化**：
- 创建索引文件 `index.json` 记录时间范围
- 按月份分文件（如 `facts_2025_12.jsonl`）
- 限制返回数量（默认10条）

**System Prompt**：
```
【回忆功能】
- 当主人问"还记得吗"、"之前聊过"、"去年"等关键词时：
  * 使用 memory(action='recall', type='...', keyword='...')
  * 自然表达："让我想想...哦对了，去年12月你跟我说过..."
  * 不要说"正在搜索归档"等技术词汇
```

**预计工作量**：3-4小时

---

### P2 - 中期实施（1个月内）

#### 5. Opus解码器预分配（内存优化阶段2）

**价值**：避免运行时大块内存分配导致的碎片化

**实现方案**（from 内存优化计划.md）：
```cpp
// 文件：main/audio/opus_decoder.cc
class OpusDecoder {
    static constexpr size_t DECODER_WORKING_SIZE = 120 * 1024;  // 120KB
    uint8_t* working_buffer_ = nullptr;

    void PreallocateOnStartup() {
        working_buffer_ = (uint8_t*)heap_caps_malloc(DECODER_WORKING_SIZE, MALLOC_CAP_SPIRAM);
    }
};
```

**集成点**：
- `Application::Init()` - 启动时预分配

**预计工作量**：1-2小时

---

#### 6. 操作调度器（内存优化阶段2）

**价值**：避免同时执行多个高内存操作

**实现方案**（from 内存优化计划.md）：
```cpp
// 文件：main/memory/operation_scheduler.h/cc
enum OperationPriority {
    PRIORITY_HIGH = 0,    // 语音交互
    PRIORITY_MEDIUM = 1,  // 记忆写入
    PRIORITY_LOW = 2      // 后台归档
};

class OperationScheduler {
    bool CanStartOperation(OperationType type);
    void MarkOperationStart(OperationType type);
    void MarkOperationEnd(OperationType type);
};
```

**调度策略**：
- 语音交互进行时：延迟记忆写入、暂停归档
- 记忆写入进行时：延迟动画加载
- 后台归档：只在空闲时执行

**预计工作量**：3-4小时

---

### P3 - 长期实施（2-3个月内）

#### 7. 系统内存监控（内存优化阶段3）

**价值**：实时监控内存使用，触发降级策略

**实现方案**（from 内存优化计划.md）：
```cpp
// 文件：main/memory/memory_monitor.h/cc
class MemoryMonitor {
    size_t GetAvailableHeap();
    size_t GetAvailablePSRAM();
    bool IsMemoryLow();  // 可用内存 < 50KB

    void EnableLowMemoryMode();  // 降级策略
    void DisableLowMemoryMode();
};
```

**降级策略**：
- 可用内存 < 50KB：
  - 停止动画播放（释放帧缓冲）
  - 延迟记忆写入（批量处理）
  - 禁用环境对白
- 恢复正常后自动恢复功能

**预计工作量**：4-5小时

---

#### 8. 性格进化增强（PersonalityEvolver）

**价值**：更自然的人格演变

**当前问题**（from 记忆系统架构说明.md）：
- 仅根据对话频率和总金币数决定阶段
- 没有考虑对话内容的情感倾向
- 阶段固定（5个阶段），缺乏细粒度

**改进方案**：
- 结合 EmotionalContext（emotion_type, emotion_intensity）
- 引入情感倾向统计（正面/中性/负面对话比例）
- 更细粒度的人格特征（如"活泼度"、"依赖度"）

**预计工作量**：5-6小时

---

## 技术约束和注意事项

### 内存约束

| 资源 | 容量 | 当前使用 | 备注 |
|------|------|---------|------|
| **Heap** | ~300KB | ~200KB | 需保留50KB缓冲 |
| **PSRAM** | 2MB | ~1MB | Opus解码使用120KB |
| **NVS** | 48KB | ~11KB (31%) | 目标保持 < 50% |
| **Asset (SPIFFS)** | 8MB | ~2.5MB (动画) | 可用5.5MB for归档 |

### 性能约束

| 操作 | 目标耗时 | 当前耗时 | 备注 |
|------|---------|---------|------|
| `memory(action='read')` | <150ms | 50-150ms ✅ | 按需加载已优化 |
| `memory(action='read', type='schedule')` | <300ms | 100-200ms ✅ | 完整查询 |
| `memory(action='write')` | <200ms | 100-200ms ✅ | NVS写入 |
| 日程冲突检查 | <100ms | - | 新增功能 |
| 归档写入 | <500ms | - | 后台操作 |
| 回忆检索 | <1000ms | - | 异步操作 |

### 用户体验约束

| 原则 | 说明 |
|------|------|
| **自然对话** | 年糕的反应必须自然，不能机械读取数据 |
| **无感知优化** | 优化对用户透明，不能影响正常交互 |
| **渐进增强** | 新功能逐步启用，不能破坏现有体验 |
| **降级优雅** | 低内存时自动降级，不能崩溃 |

---

## 实施路线图

### Week 1（本周）
- [x] 按需加载优化（已完成）
- [x] 重复日程支持（已完成）
- [ ] 日程冲突检测（Phase 4）
- [ ] 深层记忆归档（阶段1）

### Week 2-3
- [ ] 上下文相关日程建议（Phase 5）
- [ ] 回忆检索功能（阶段2）
- [ ] 测试和优化

### Week 4
- [ ] Opus解码器预分配
- [ ] 操作调度器
- [ ] 性能测试和调优

### Month 2-3
- [ ] 系统内存监控
- [ ] 性格进化增强
- [ ] 长期稳定性测试

---

## 测试计划

### 功能测试

#### 日程冲突检测
```python
# 测试1: 添加重叠日程
memory(action='write', type='schedule', content='会议A', datetime='2026-02-05 14:00')
memory(action='write', type='schedule', content='会议B', datetime='2026-02-05 14:30')
# 预期：返回冲突提示和建议时间

# 测试2: 添加无冲突日程
memory(action='write', type='schedule', content='会议C', datetime='2026-02-05 16:00')
# 预期：成功添加
```

#### 深层记忆归档
```python
# 测试1: 添加超过30条Facts
for i in range(35):
    memory(action='write', type='fact', content=f'事实{i}')
# 预期：自动归档最早的5条到 /spiffs/memory/facts_archive.jsonl

# 测试2: 查看NVS使用量
# 预期：保持在30条以内，NVS占用稳定
```

#### 回忆检索
```python
# 测试1: 按时间范围回忆
memory(action='recall', type='fact', start_date='2025-12-01', end_date='2025-12-31')
# 预期：返回归档中的Facts，耗时 < 500ms

# 测试2: 按关键词搜索
memory(action='recall', type='moment', keyword='生日')
# 预期：返回包含"生日"的Moments，耗时 < 1000ms
```

### 性能测试

#### 内存压力测试
```cpp
// 模拟高负载场景
1. 启动语音对话（Opus解码占用120KB）
2. 同时写入多个记忆（NVS操作）
3. 触发归档操作（SPIFFS写入）
4. 播放动画（帧缓冲占用）

// 预期：
// - 可用内存保持 > 50KB
// - 无内存分配失败
// - 操作调度器正常工作
```

#### 长期稳定性测试
```cpp
// 运行7天
1. 每小时触发一次对话
2. 每天添加5-10个记忆
3. 每天触发归档
4. 监控内存使用、NVS占用、Asset占用

// 预期：
// - NVS占用稳定在 < 50%
// - Asset归档正常增长
// - 无内存泄漏
// - 系统持续稳定运行
```

---

## 风险评估

### 高风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| **SPIFFS写入失败** | 归档数据丢失 | 写入前检查空间，失败时重试，日志记录 |
| **内存碎片化** | 分配失败，系统不稳定 | 预分配大块内存，操作调度器 |
| **NVS写入冲突** | 数据损坏 | 使用mutex保护，写入前验证 |

### 中风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| **检索超时** | 用户体验下降 | 设置超时（1秒），限制返回数量 |
| **归档文件过大** | 影响检索性能 | 按月份分文件，定期清理旧文件 |
| **日程冲突误判** | 用户体验下降 | 充分测试，允许用户强制添加 |

### 低风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| **动画加载延迟** | UI响应延迟 | 延迟初始化，后台加载 |
| **环境对白频繁** | 用户烦躁 | 调整触发间隔，增加随机性 |

---

## 总结

### 核心价值

1. **日程管理增强**：冲突检测 + 上下文建议 → 更智能的日程助手
2. **深层记忆存储**：Asset归档 + 回忆检索 → 长期记忆能力
3. **内存优化**：预分配 + 调度器 + 监控 → 系统稳定性

### 预期效果

| 指标 | 当前 | 目标 |
|------|------|------|
| NVS占用 | 31% | < 50% (长期稳定) |
| 可用内存 | ~100KB | > 50KB (压力下) |
| 日程冲突检测 | 无 | 100%准确 |
| 历史记忆保留 | 30天 | 3年+ |
| 系统稳定性 | 良好 | 7天×24小时 |

### 成功标准

- ✅ 日程冲突检测准确率 > 95%
- ✅ 归档功能稳定运行 > 7天
- ✅ 回忆检索耗时 < 1秒
- ✅ 内存占用稳定，无泄漏
- ✅ 用户体验自然，无感知延迟

---

## 附录

### 相关文档

- [记忆系统架构说明.md](记忆系统架构说明.md) - 详细的数据结构和API
- [内存优化计划.md](内存优化计划.md) - 内存冲突优化策略
- [交互流程说明.md](交互流程说明.md) - 完整的交互流程
- [内存优化说明.md](内存优化说明.md) - 按需加载和深层记忆方案
- [改动说明.md](改动说明.md) - 动画系统实现细节

### 关键文件

| 文件 | 功能 | 优先级 |
|------|------|--------|
| `main/memory/memory_storage.h/cc` | 记忆存储核心 | P0 |
| `main/memory/memory_mcp_tools.cc` | MCP工具接口 | P0 |
| `main/memory/memory_archive.h/cc` | 归档管理器（新增） | P0 |
| `main/memory/operation_scheduler.h/cc` | 操作调度器（新增） | P1 |
| `main/memory/memory_monitor.h/cc` | 内存监控（新增） | P2 |
| `system_prompt.txt` | AI对话提示 | P0 |

---

**最后更新**：2026-02-02
**版本**：v1.0
**负责人**：AI Assistant (Claude Sonnet 4.5)
