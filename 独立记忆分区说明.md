# 独立记忆分区实施说明

**实施日期**：2026-02-02
**方案**：创建独立 memory 分区，与 assets 分区分离

---

## 一、Flash 空间分析

### 原始分区布局（16MB Flash）

| 分区名称 | 起始地址 | 大小 | 用途 | 状态 |
|---------|---------|------|------|------|
| nvs | 0x009000 | 16 KB | NVS键值存储 | ✅ 使用中 |
| otadata | 0x00D000 | 8 KB | OTA状态 | ✅ 使用中 |
| phy_init | 0x00F000 | 4 KB | RF参数 | ✅ 使用中 |
| ota_0 | 0x020000 | 3968 KB | APP固件槽0 | ✅ 使用中 |
| ota_1 | 0x410000 | 3968 KB | APP固件槽1 | ✅ 使用中 |
| assets | 0x800000 | 4500 KB | 动画/背景 | ⚠️ 几乎满载 (4480KB/4500KB) |
| **未使用** | 0xC69800 | **3610 KB** | - | 🎯 **可利用** |

**问题**：assets 分区只剩 20KB 空间，SPIFFS 无法初始化归档功能。

---

## 二、新分区方案

### 修改后的分区布局

| 分区名称 | 起始地址 | 大小 | 用途 |
|---------|---------|------|------|
| assets | 0x800000 | 4500 KB | 动画/背景（保持不变） |
| **memory** | **0xC6A000** | **3 MB** | **记忆归档专用** ⭐ |

**优势**：
- ✅ 不影响现有 assets 分区
- ✅ 动画资源无需重新烧录
- ✅ 3MB 空间足够存储数年记忆
- ✅ 架构清晰，职责分离

---

## 三、修改的文件

### 1. 分区表配置

**文件**：[partitions/v2/16m_c3.csv](partitions/v2/16m_c3.csv)

**修改**：添加 memory 分区
```csv
# 第 9 行新增
memory,   data, spiffs,  0xC6A000,  3M
```

**对比**：
```diff
  assets,   data, spiffs,  0x800000,  4500K
+ memory,   data, spiffs,  0xC6A000,  3M
```

---

### 2. 归档管理器实现

**文件**：[main/memory/memory_archive.cc](main/memory/memory_archive.cc)

#### 修改 1：挂载配置（第 30-36 行）
```cpp
// 修改前
esp_vfs_spiffs_conf_t conf = {
    .base_path = "/spiffs",
    .partition_label = "assets",
    .max_files = 5,
    .format_if_mount_failed = false
};

// 修改后
esp_vfs_spiffs_conf_t conf = {
    .base_path = "/spiffs",
    .partition_label = "memory",  // ← 改为 memory 分区
    .max_files = 5,
    .format_if_mount_failed = true  // ← 首次自动格式化
};
```

#### 修改 2：分区信息查询（第 52-58 行）
```cpp
// 修改前
ret = esp_spiffs_info("assets", &total, &used);
ESP_LOGI(TAG, "SPIFFS: total=%zu KB, used=%zu KB, available=%zu KB", ...);

// 修改后
ret = esp_spiffs_info("memory", &total, &used);
ESP_LOGI(TAG, "Memory SPIFFS: total=%zu KB, used=%zu KB, available=%zu KB", ...);
```

#### 修改 3：卸载操作（第 16-21 行）
```cpp
// 修改前
esp_vfs_spiffs_unregister("assets");
ESP_LOGI(TAG, "SPIFFS unmounted");

// 修改后
esp_vfs_spiffs_unregister("memory");
ESP_LOGI(TAG, "Memory SPIFFS unmounted");
```

---

## 四、编译和烧录

### 步骤 1：编译固件
```bash
cd d:\xiaozhi\xiaozhi-esp32-v2\xiaozhi-esp32-v2
idf.py build
```

### 步骤 2：烧录固件
```bash
idf.py -p COM<端口号> flash
```

### 步骤 3：查看日志验证
```bash
idf.py -p COM<端口号> monitor
```

**预期日志**：
```
I (xxx) MemArchive: Memory SPIFFS: total=3072 KB, used=0 KB, available=3072 KB
I (xxx) MemArchive: Memory archive initialized
```

---

## 五、验证测试

### 测试 1：SPIFFS 挂载成功
**预期**：启动日志显示 "Memory archive initialized"

### 测试 2：自动归档功能
```python
# 添加超过 20 条 Facts 触发归档
for i in range(25):
    memory(action='write', type='fact', content=f'测试事实{i}')
```

**预期日志**：
```
I (xxx) MemArchive: Archived 5 facts to /spiffs/memory/facts_archive.jsonl
```

### 测试 3：查看归档文件
通过串口或文件系统工具检查：
```
/spiffs/memory/
  ├── facts_archive.jsonl
  └── moments_archive.jsonl
```

---

## 六、容量规划

### 记忆归档容量估算

| 使用时长 | Facts 数量 | Moments 数量 | 预估大小 | 剩余空间 |
|---------|-----------|-------------|---------|---------|
| 3 个月 | ~1000 条 | ~500 条 | ~500 KB | 2.5 MB |
| 1 年 | ~4000 条 | ~2000 条 | ~2 MB | 1 MB |
| 3 年 | ~12000 条 | ~6000 条 | ~6 MB | ⚠️ 需扩容 |

**注**：3 年后可考虑：
- 删除最早的归档（保留最近 2 年）
- 扩大 memory 分区（牺牲 ota_1 空间）
- 压缩归档文件

---

## 七、技术细节

### 分区地址计算

```
assets 结束地址：0x800000 + 4500KB = 0x800000 + 0x469800 = 0xC69800
memory 起始地址：对齐到 4KB 边界 = 0xC6A000（0xC69800 向上对齐）
memory 大小：3MB = 0x300000
memory 结束地址：0xC6A000 + 0x300000 = 0xF6A000

Flash 总大小：16MB = 0x1000000
剩余空间：0x1000000 - 0xF6A000 = 0x96000 = 600KB（保留）
```

### SPIFFS 格式化机制

**首次启动**：
1. `esp_vfs_spiffs_register()` 尝试挂载
2. 挂载失败（分区为空）
3. `format_if_mount_failed=true` 触发自动格式化
4. 格式化成功后重新挂载
5. 创建 `/spiffs/memory/` 目录

**后续启动**：
- 直接挂载，无需格式化
- 读取已有的归档文件

---

## 八、与其他方案对比

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| A. 临时禁用归档 | 快速，无需烧录 | 功能缺失 | ⭐⭐ 临时 |
| B. 扩大 assets 到 8M | 容量最大 | **需重新烧录动画** | ⭐⭐⭐ 可行 |
| **C. 独立 memory 分区** | **不影响动画，架构清晰** | 需编译烧录 | ⭐⭐⭐⭐⭐ **最佳** |

---

## 九、注意事项

### ⚠️ 动画资源兼容性
- **assets 分区保持不变**（0x800000, 4500KB）
- **无需重新烧录动画**，原有动画继续使用
- 新增的 memory 分区完全独立

### ⚠️ OTA 升级兼容性
- 新固件包含新分区表
- OTA 后 memory 分区自动格式化并初始化
- 旧固件无法识别 memory 分区（但不影响运行）

### ⚠️ 回退风险
- 如果回退到旧固件，memory 分区不会被使用
- 归档功能失效，但不会崩溃（优雅降级）

---

## 十、总结

### 已完成的工作
- ✅ 修改分区表：添加 3MB memory 分区
- ✅ 修改归档代码：从 assets 切换到 memory
- ✅ 启用首次自动格式化
- ✅ 更新日志标识

### 下一步操作
1. 编译并烧录固件
2. 查看日志确认 SPIFFS 挂载成功
3. 测试记忆归档功能
4. 长期运行验证稳定性

### 预期效果
- 记忆归档功能正常工作
- 动画资源不受影响
- 3MB 空间可存储数年记忆
- 架构清晰，易于维护

---

**最后更新**：2026-02-02
**文档版本**：v1.0
**作者**：AI Assistant (Claude Sonnet 4.5)
